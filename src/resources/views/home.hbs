<!-- Content -->


<div class="container-xxl flex-grow-1 container-p-y">
  <div class="row">
    <div class="col-lg-8 mb-4 order-0">
      <div class="card">
        <div class="d-flex align-items-end row">
          <div class="col-sm-7">
            <div class="card-body">
              <h5 class="card-title text-primary">Xin chào! 🎉</h5>
              <p class="mb-4">
                Hãy kiểm tra
                <span class="fw-bold">số liệu thống kê</span>
                của bạn trong tháng và năm nay nhé !
              </p>
            </div>
          </div>
          <div class="col-sm-5 text-center text-sm-left">
            <div class="card-body pb-0 px-0 px-md-4">
              <img src="../assets/img/illustrations/man-with-laptop-light.png" height="140" alt="View Badge User"
                data-app-dark-img="illustrations/man-with-laptop-dark.png"
                data-app-light-img="illustrations/man-with-laptop-light.png" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-md-4 order-1">
      <div class="row">

        <div class="col-lg-6 col-md-12 col-6 mb-4">
          <div class="card">
            <div class="card-body">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="avatar flex-shrink-0">
                  <img src="../assets/img/icons/unicons/chart-success.png" alt="chart success" class="rounded" />
                </div>
              </div>
              <span class="fw-semibold d-block mb-1">Tổng doanh thu trong tháng</span>
              <h3 class="card-title mb-2"></h3>

              <small class="text-success fw-semibold" id="totals">
                <script>
                  const getMonths = (date) => {
                    const temp = new Date(date);
                    return Number(temp.getMonth() + 1);
                  }
                  const getDataTotal = async () => {
                    let response = await fetch(`http://localhost:3001/thanhtoan`);
                    let data = await response.json();
                    let items = [];
                    for (var i = 1; i <= 12; i++) {
                      items.push(
                        {
                          month: i,
                          amount: 0
                        }
                      )
                    }
                    data.map((item) => {
                      items.forEach(record => {
                        if (record.month === getMonths(item.createdAt) && item.trang_thai_duyet === "ĐÃ DUYỆT") {
                          record.amount += parseInt(item.thanh_tien.replaceAll('.', ''));
                        }
                      })

                    })
                    return items
                  }

                  const formatPrice = (number) => {
                    return new Intl.NumberFormat("it-IT", {
                      style: "currency",
                      currency: "VND",
                    }).format(number);
                  }

                  getDataTotal().then((data) => {
                    data.map((it) => {
                      if (it.month === getMonths(new Date())) {
                        document.getElementById("totals").innerHTML = formatPrice(it.amount)

                      }
                    })

                  })
                </script>
              </small>
            </div>
          </div>
        </div>

        <div class="col-lg-6 col-md-12 col-6 mb-4">
          <div class="card">
            <div class="card-body">
              <div class="card-title d-flex align-items-start justify-content-between">
                <div class="avatar flex-shrink-0">
                  <img src="../assets/img/icons/unicons/wallet-info.png" alt="Credit Card" class="rounded" />
                </div>
              </div>
              <span>Tổng lượng đơn đặt trong tháng</span>
              <p></p>
              <small class="text-success fw-semibold" id="sumBills">
                +28.42%</small>
                  <script>
                
                const get_day_of_months = (y, month) => {
                  return new Date(y, month, 0).getDate();
                };

                const Months = (d) => {
                  const temp = new Date(d);
                  return Number(temp.getMonth() + 1);
                }
                const getDates = (date1) => {
                  const temp = new Date(date1);
                  return Number(temp.getDate());
                }
                const datec = new Date();
                const monthc = datec.getMonth() + 1;
                const yearc = datec.getFullYear();

      
                const countDatec = get_day_of_months(yearc, monthc);
                let label = [];

                const SumBill = async () => {
                  let response = await fetch(`http://localhost:3001/taikhoan`);
                  let data = await response.json();

                  let res = await fetch(`http://localhost:3001/thanhtoan`);
                  let databill = await res.json();

                  let countSignUp = [];
                  for (let i = 1; i <= countDatec; i++) {
                    label.push(i);
                    countSignUp.push(
                      {
                        date: i,
                        amount: 0,
                        amountBill: 0,
                      }
                    )
                  }

                  for (let i = 0; i < countSignUp.length; i++) {
                    data.map((dataItem) => {
                      if (Months(dataItem.createdAt) === Months(new Date()) && getDates(dataItem.createdAt) === countSignUp[i].date) {
                        countSignUp[i].amount++;

                      }
                    })
                    databill.map((itemData) => {
                      if (Months(itemData.createdAt) === Months(new Date()) && getDates(itemData.createdAt) === countSignUp[i].date) {
                        countSignUp[i].amountBill++;
                      }
                    })
                  }
                  return countSignUp
                }
                let sumTest = 0;
                SumBill().then((data) => {
                    console.log('huhuuuh', data);
                    for(let p = 0; p<data.length; p++){
                      sumTest += data[p].amountBill
                    }
                    document.getElementById("sumBills").innerHTML = sumTest
                })

              </script>

           

            </div>
          </div>
        </div>
      </div>
    </div>



<!-- Total Revenue Biểu đồ cột =================================================================================================-->
    <div class="col-12 col-lg-8 order-2 order-md-3 order-lg-2 mb-4">
      <div class="card">
        <div class="row row-bordered g-0">
          <div class="col-md-12">
            <h5 class="card-header m-0 me-2 pb-3">
              Doanh thu theo tháng
            </h5>
            <canvas id="myChart" style="width:100%;max-width:1000px"></canvas>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
            <script>
              const getData = async () => {
                let response = await fetch(`http://localhost:3001/thanhtoan`);
                let data = await response.json();
                let items = [];
                for (var i = 1; i <= 12; i++) {
                  items.push(
                    {
                      month: i,
                      amount: 0
                    }
                  )
                }
                data.map((item) => {
                  items.forEach(record => {
                    if (record.month === getMonth(item.createdAt) && item.trang_thai_duyet === "ĐÃ DUYỆT") {
                      record.amount += parseInt(item.thanh_tien.replaceAll('.', ''));
                    }
                  })

                })
                return items
              }

              const getMonth = (date) => {
                const temp = new Date(date);
                return Number(temp.getMonth() + 1);
              }
              const sum = (array) => {
                var suma = 0;
                for (let i = 0; i < array.length; i++) {
                  suma = suma + array[i];
                }
                return suma;
              }

              function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                  color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
              }

              getData().then((datat) => {
                var xValues = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"];
                var yValues = datat.map(data => data.amount);
                var barColors = [];

                yValues.forEach(i => {
                  barColors.push(getRandomColor())
                })

                new Chart("myChart", {
                  type: "bar",
                  data: {
                    labels: xValues,
                    datasets: [{
                      backgroundColor: barColors,
                      data: yValues
                    }

                    ]
                  },
                  options: {
                    legend: { display: false },
                    title: {
                      display: true,
                      text: "Doanh thu tháng"
                    }
                  }
                });
              });
            </script>

          </div>
          
        </div>
      </div>
    </div>
<!-- Này là Payment==========================================================================================================-->
    <div class="col-12 col-md-8 col-lg-4 order-3 order-md-2">
      
<!-- Này là Tran==========================================================================================================-->
        
<!-- Này là Doanh thu trong năm==========================================================================================================-->
    <div class="row"> 
        <div class="col-12 mb-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between flex-sm-row flex-column gap-3">
                <div class="d-flex flex-sm-column flex-row align-items-start justify-content-between">
                  <div class="card-title">
                    <h5 class="text-nowrap mb-2">Doanh thu trong năm</h5>
                    <span class="badge bg-label-warning rounded-pill" id="yearCurrent"></span>
                    <script>
                      const getYear = (date) => {
                        const temp = new Date(date);
                        return Number(temp.getFullYear());
                      }
                      const year1 = getYear(new Date());
                      document.getElementById("yearCurrent").innerHTML = `Năm` + ` ` + year1
                    </script>
                  </div>
                  <div class="mt-sm-auto">
                    <h3 class="mb-0" id="sumYear"></h3>
                    <script>

                      const getYears = (date) => {
                        const temp = new Date(date);
                        return Number(temp.getFullYear());
                      }

                      const sumYear = async () => {
                          let response = await fetch(`http://localhost:3001/thanhtoan`);
                          let data = await response.json();
                          let items = [];
                    for (var i = 1; i <= 12; i++) {
                      items.push(
                        {
                          month: i,
                          amount: 0
                        }
                      )
                    }
                    data.map((item) => {
                      items.forEach(record => {
                        if (record.month === getMonths(item.createdAt) && item.trang_thai_duyet === "ĐÃ DUYỆT") {
                          record.amount += parseInt(item.thanh_tien.replaceAll('.', ''));
                        }
                      })

                    })
                    return items
                  }

                  const formatPrices = (number) => {
                    return new Intl.NumberFormat("it-IT", {
                      style: "currency",
                      currency: "VND",
                    }).format(number);
                  }


                  let sum1 = 0;

                  sumYear().then((data) => {
                    data.map((it) => {
                        sum1 += it.amount;
                        console.log(data);
                        document.getElementById("sumYear").innerHTML = formatPrices(sum1)

                    })

                  })
                    </script>

                  </div>
                </div>
                <div id="profileReportChart"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- Thống kê số lượng sp==========================================================================================================-->
  <div class="row">
    <div class="col-md-6 col-lg-4 col-xl-4 order-0 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between pb-0">
          <div class="card-title mb-0">
            <h5 class="m-0 me-2">Thống kê số lượng sản phẩm</h5>
            <small class="text-muted" id="totalTour"></small>
            <script>
              const getTotalData = async () => {
                let response = await fetch(`http://localhost:3001/tour`);
                let data = await response.json();
                return data;
              }
              getTotalData().then((data) => {
                document.getElementById("totalTour").innerHTML = data.length;
              })
            </script>
          </div>

        </div>

        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex flex-column align-items-center gap-1">
            </div>

            <canvas id="pieChart" style="width:100%;max-width:250px"></canvas>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
            <script>
              const getDataTour = async () => {
                let response = await fetch(`http://localhost:3001/tour`);
                let data = await response.json();
                let items = [
                  {
                    name: 'TMB', count: 0
                  },
                  {
                    name: 'TMT', count: 0
                  },
                  {
                    name: 'TNB', count: 0
                  },
                  {
                    name: 'DNB', count: 0
                  }
                ]

                for (let i = 0; i < items.length; i++) {

                  data.map((item) => {
                    if (item.matour.slice(0, 3) === items[i].name) {
                      items[i].count++;
                    }
                  })
                }
                return items;
              }
              getDataTour().then((data) => {
                new Chart("pieChart", {
                  type: "pie",
                  data: {
                    labels: [
                      'Tour Miền Bắc',
                      'Tour Miền Trung',
                      'Tour Miền Tây Nam Bộ',
                      'Tour Miền Đông Nam Bộ',
                    ],
                    datasets: [{
                      label: 'My First Dataset',
                      data: data.map((data) => data.count),
                      backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                      ],
                      hoverOffset: 4
                    }]
                  }
                });
              })

            </script>
          </div>


          <ul class="p-0 m-0">
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-primary"><i class="bx bx-mobile-alt"></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">

                <div class="me-2">
                  <h6 class="mb-0">Tour Miền Bắc</h6>
                  <small class="text-muted">
                    Hà Nội, Hải Phòng,...
                  </small>
                </div>
                <div class="user-progress">
                  <small class="fw-semibold" id="demo">
                  </small>
                  <script>
                    getDataTour().then((data) => {
                      data[0].name
                      document.getElementById("demo").innerHTML = data[0].count;
                    })

                  </script>
                </div>
              </div>
            </li>

            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-success"><i class="bx bx-closet"></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <h6 class="mb-0">Tour Miền Trung</h6>
                  <small class="text-muted">Huế, Đà Nẵng, Quảng Nam,...</small>
                </div>
                <div class="user-progress">
                  <small class="fw-semibold" id="mt"></small>
                  <script>
                    getDataTour().then((data) => {
                      data[0].name
                      document.getElementById("mt").innerHTML = data[1].count;
                    })

                  </script>
                </div>
              </div>
            </li>

            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-info"><i class="bx bx-home-alt"></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <h6 class="mb-0">Tour Miền Tây Nam Bộ</h6>
                  <small class="text-muted">Cần Thơ, Bạc Liêu, Sóc Trăng,....</small>
                </div>
                <div class="user-progress">
                  <small class="fw-semibold" id="tnb">
                    <script>
                      getDataTour().then((data) => {
                        data[0].name
                        document.getElementById("tnb").innerHTML = data[2].count;
                      })

                    </script>
                  </small>
                </div>
              </div>
            </li>

            <li class="d-flex">
              <div class="avatar flex-shrink-0 me-3">
                <span class="avatar-initial rounded bg-label-secondary"><i class="bx bx-football"></i></span>
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <h6 class="mb-0">Tour Miền Đông Nam Bộ</h6>
                  <small class="text-muted">Đồng Nai, TP.Hồ Chí Minh, Côn Đảo,... </small>
                </div>
                <div class="user-progress">
                  <small class="fw-semibold" id="dnb"></small>
                  <script>
                    getDataTour().then((data) => {
                      data[0].name
                      document.getElementById("dnb").innerHTML = data[3].count;
                    })

                  </script>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!--/ Order Statistics -->

    <!-- Expense Overview -->
    <div class="col-md-12 col-lg-8 order-1 mb-6">
      <div class="card h-100">
        <div class="card-body px-0">
          <div class="tab-content p-0">
            <div class="tab-pane fade show active" id="navs-tabs-line-card-income" role="tabpanel">
              <div class="d-flex p-4 pt-3">
                <div class="avatar flex-shrink-0 me-3">
                  <img src="../assets/img/icons/unicons/wallet.png" alt="User" />
                </div>
                <div>
                  <small class="text-muted d-block">Thống kê số lượng đăng ký tài khoản trong tháng</small>
                  <div class="d-flex align-items-center">
                    <h6 class="mb-0 me-1"></h6>
                    <small class="text-success fw-semibold">

                    </small>


                  </div>

                </div>
              </div>
              <canvas id="lineChart" style="width:100%;max-width:800px"></canvas>
              <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
              <script>
                const get_day_of_month = (year, month) => {
                  return new Date(year, month, 0).getDate();
                };
                const Month = (date) => {
                  const temp = new Date(date);
                  return Number(temp.getMonth() + 1);
                }
                const getDate = (date) => {
                  const temp = new Date(date);
                  return Number(temp.getDate());
                }
                const date = new Date();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                console.log('số ngày trong tháng này: ', get_day_of_month(year, month));
                const countDate = get_day_of_month(year, month);
                let labels = [];

                const getUserAmount = async () => {
                  let response = await fetch(`http://localhost:3001/taikhoan`);
                  let data = await response.json();

                  let res = await fetch(`http://localhost:3001/thanhtoan`);
                  let databill = await res.json();

                  let countSignUp = [];
                  for (let i = 1; i <= countDate; i++) {
                    labels.push(i);
                    countSignUp.push(
                      {
                        date: i,
                        amount: 0,
                        amountBill: 0,
                      }
                    )
                  }

                  console.log('tháng này:', Month(new Date()));

                  for (let i = 0; i < countSignUp.length; i++) {
                    data.map((dataItem) => {
                      if (Month(dataItem.createdAt) === Month(new Date()) && getDate(dataItem.createdAt) === countSignUp[i].date) {
                        countSignUp[i].amount++;

                      }
                    })
                    databill.map((itemData) => {
                      if (Month(itemData.createdAt) === Month(new Date()) && getDate(itemData.createdAt) === countSignUp[i].date) {
                        countSignUp[i].amountBill++;
                      }
                    })
                  }
                  return countSignUp
                }

                getUserAmount().then((data) => {
                  new Chart("lineChart", {
                    type: "line",
                    data: {
                      labels: data.map((data) => data.date),
                      datasets: [
                        {
                          label: 'Số lượng đăng ký tài khoản',
                          data: data.map((data) => data.amount),
                          fill: false,
                          borderColor: 'rgb(75, 192, 192)',
                          tension: 0.1
                        },
                        {
                          label: 'Số lượng đặt tour',
                          data: data.map((data) => data.amountBill),
                          fill: false,
                          borderColor: 'red',
                          tension: 0.1
                        }
                      ]

                    },

                  });

                })

              </script>
              {{!-- <div id="incomeChart"></div> --}}

            </div>
          </div>
        </div>
      </div>
    </div>
    <!--/ Expense Overview -->

    <!-- Transactions -->
    {{!-- <div class="col-md-6 col-lg-4 order-2 mb-4">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="card-title m-0 me-2">Transactions</h5>
          <div class="dropdown">
            <button class="btn p-0" type="button" id="transactionID" data-bs-toggle="dropdown" aria-haspopup="true"
              aria-expanded="false">
              <i class="bx bx-dots-vertical-rounded"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="transactionID">
              <a class="dropdown-item" href="javascript:void(0);">Last 28 Days</a>
              <a class="dropdown-item" href="javascript:void(0);">Last Month</a>
              <a class="dropdown-item" href="javascript:void(0);">Last Year</a>
            </div>
          </div>
        </div>
        <div class="card-body">
          <ul class="p-0 m-0">
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/paypal.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Paypal</small>
                  <h6 class="mb-0">Send money</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">+82.6</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Wallet</small>
                  <h6 class="mb-0">Mac'D</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">+270.69</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/chart.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Transfer</small>
                  <h6 class="mb-0">Refund</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">+637.91</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/cc-success.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Credit Card</small>
                  <h6 class="mb-0">Ordered Food</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">-838.71</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
            <li class="d-flex mb-4 pb-1">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/wallet.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Wallet</small>
                  <h6 class="mb-0">Starbucks</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">+203.33</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
            <li class="d-flex">
              <div class="avatar flex-shrink-0 me-3">
                <img src="../assets/img/icons/unicons/cc-warning.png" alt="User" class="rounded" />
              </div>
              <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                <div class="me-2">
                  <small class="text-muted d-block mb-1">Mastercard</small>
                  <h6 class="mb-0">Ordered Food</h6>
                </div>
                <div class="user-progress d-flex align-items-center gap-1">
                  <h6 class="mb-0">-92.45</h6>
                  <span class="text-muted">USD</span>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div> --}}
    <!--/ Transactions -->
  </div>
</div>
